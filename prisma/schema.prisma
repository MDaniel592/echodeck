generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

enum UserRole {
  admin
  user
}

model Song {
  id        Int      @id @default(autoincrement())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  artist    String?
  album     String?
  albumArtist String?
  trackNumber Int?
  discNumber Int?
  year      Int?
  genre     String?
  isrc      String?
  lyrics    String?
  bitrate   Int?
  sampleRate Int?
  channels  Int?
  duration  Int?
  format    String
  quality   String?
  source    String
  sourceUrl String?
  filePath  String
  relativePath String?
  fileMtime DateTime?
  fileHash  String?
  coverPath String?
  thumbnail String?
  fileSize  Int?
  artistId  Int?
  artistRef Artist?  @relation(fields: [artistId], references: [id], onDelete: SetNull)
  albumId   Int?
  albumRef  Album?   @relation(fields: [albumId], references: [id], onDelete: SetNull)
  libraryId Int?
  library   Library? @relation(fields: [libraryId], references: [id], onDelete: SetNull)
  playlistId Int?
  playlist   Playlist? @relation(fields: [playlistId], references: [id], onDelete: SetNull)
  downloadTaskId Int?
  downloadTask DownloadTask? @relation(fields: [downloadTaskId], references: [id], onDelete: SetNull)
  playbackSessionsCurrent PlaybackSession[] @relation("CurrentPlaybackSong")
  playbackQueueItems PlaybackQueueItem[] @relation("QueueSong")
  createdAt DateTime @default(now())

  @@unique([userId, source, sourceUrl])
  @@index([playlistId])
  @@index([source])
  @@index([createdAt])
  @@index([title])
  @@index([artist])
  @@index([userId, createdAt])
  @@index([userId, playlistId])
  @@index([userId, albumId, discNumber, trackNumber])
  @@index([artistId])
  @@index([albumId])
  @@index([libraryId])
}

model User {
  id           Int      @id @default(autoincrement())
  username     String   @unique
  passwordHash String
  role         UserRole @default(admin)
  disabledAt   DateTime?
  createdAt    DateTime @default(now())
  songs        Song[]
  playlists    Playlist[]
  downloadTasks DownloadTask[]
  downloadTaskEvents DownloadTaskEvent[]
  playbackSessions PlaybackSession[]
  libraries    Library[]
  artists      Artist[]
  albums       Album[]
}

model Playlist {
  id        Int      @id @default(autoincrement())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  createdAt DateTime @default(now())
  songs     Song[]
  downloadTasks DownloadTask[]

  @@unique([userId, name])
}

model DownloadTask {
  id                  Int                 @id @default(autoincrement())
  userId              Int?
  user                User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  source              String
  sourceUrl           String
  format              String
  quality             String?
  bestAudioPreference String?
  playlistId          Int?
  playlist            Playlist?           @relation(fields: [playlistId], references: [id], onDelete: SetNull)
  status              String              @default("queued")
  playlistTitle       String?
  isPlaylist          Boolean             @default(false)
  totalItems          Int?
  processedItems      Int                 @default(0)
  successfulItems     Int                 @default(0)
  failedItems         Int                 @default(0)
  errorMessage        String?
  workerPid           Int?
  heartbeatAt         DateTime?
  createdAt           DateTime            @default(now())
  startedAt           DateTime?
  completedAt         DateTime?
  updatedAt           DateTime            @updatedAt
  songs               Song[]
  events              DownloadTaskEvent[]

  @@index([status])
  @@index([createdAt])
  @@index([userId, status, createdAt])
}

model DownloadTaskEvent {
  id        Int          @id @default(autoincrement())
  userId    Int?
  user      User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  taskId    Int
  task      DownloadTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  level     String
  message   String
  payload   String?
  createdAt DateTime     @default(now())

  @@index([taskId])
  @@index([userId, taskId, createdAt])
}

model PlaybackSession {
  id            Int                 @id @default(autoincrement())
  userId        Int
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceId      String
  currentSongId Int?
  currentSong   Song?               @relation("CurrentPlaybackSong", fields: [currentSongId], references: [id], onDelete: SetNull)
  positionSec   Float               @default(0)
  isPlaying     Boolean             @default(false)
  repeatMode    String              @default("off")
  shuffle       Boolean             @default(false)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  queueItems    PlaybackQueueItem[]

  @@unique([userId, deviceId])
  @@index([userId, updatedAt])
}

model PlaybackQueueItem {
  id         Int             @id @default(autoincrement())
  sessionId  Int
  session    PlaybackSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  songId     Int
  song       Song            @relation("QueueSong", fields: [songId], references: [id], onDelete: Cascade)
  sortOrder  Int
  createdAt  DateTime        @default(now())

  @@unique([sessionId, sortOrder])
  @@index([sessionId, songId])
}

model Artist {
  id        Int      @id @default(autoincrement())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  sortName  String?
  mbid      String?
  createdAt DateTime @default(now())
  albums    Album[]
  songs     Song[]

  @@unique([userId, name])
  @@index([name])
}

model Album {
  id          Int      @id @default(autoincrement())
  userId      Int?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String
  artistId    Int?
  artist      Artist?  @relation(fields: [artistId], references: [id], onDelete: SetNull)
  albumArtist String?
  year        Int?
  coverPath   String?
  createdAt   DateTime @default(now())
  songs       Song[]

  @@unique([userId, title, albumArtist])
  @@index([artistId, title])
}

model Library {
  id          Int       @id @default(autoincrement())
  userId      Int?
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  createdAt   DateTime  @default(now())
  songs       Song[]
  paths       LibraryPath[]
  scanRuns    LibraryScanRun[]

  @@unique([userId, name])
}

model LibraryPath {
  id            Int      @id @default(autoincrement())
  libraryId     Int
  library       Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  path          String
  enabled       Boolean  @default(true)
  lastScannedAt DateTime?
  createdAt     DateTime @default(now())

  @@unique([libraryId, path])
}

model LibraryScanRun {
  id         Int      @id @default(autoincrement())
  libraryId  Int
  library    Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  status     String   @default("running")
  startedAt  DateTime @default(now())
  finishedAt DateTime?
  statsJson  String?
  error      String?

  @@index([libraryId, startedAt])
}
