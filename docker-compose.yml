networks:
  internal:
    external: true

services:
  echodeck:
    container_name: echodeck
    build:
      context: .
      dockerfile: Dockerfile
      args:
        YTDLP_VERSION: ${YTDLP_VERSION:?YTDLP_VERSION is required for reproducible builds}
        SPOTDL_VERSION: ${SPOTDL_VERSION:?SPOTDL_VERSION is required for reproducible builds}
        YTDLP_SHA256: ${YTDLP_SHA256:-}
        SPOTDL_SHA256: ${SPOTDL_SHA256:-}
    # ports:
    #   - "${APP_PORT:-3000}:3000"
    environment:
      DATABASE_URL: file:./data/dev.db
      NODE_ENV: production
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      SETUP_SECRET: ${SETUP_SECRET:?SETUP_SECRET is required for production}
      NODE_OPTIONS: "--max-old-space-size=256"
      NEXT_TELEMETRY_DISABLED: "1"
      SPOTIFY_CLIENT_ID: ${SPOTIFY_CLIENT_ID:-}
      SPOTIFY_CLIENT_SECRET: ${SPOTIFY_CLIENT_SECRET:-}
      SPOTIFY_AUTH_TOKEN: ${SPOTIFY_AUTH_TOKEN:-}
    volumes:
      - ./db:/app/data
      - ./downloads:/app/downloads
    restart: unless-stopped
    networks:
      - internal
    labels:
      traefik.enable: true
      traefik.docker.network: internal
      traefik.http.routers.echodeck.rule: Host(`echodeck.peaky-blinders.dedyn.io`)
      traefik.http.routers.echodeck.entrypoints: websecure
      traefik.http.routers.echodeck.tls.certresolver: desec
      traefik.http.services.echodeck.loadbalancer.server.port: 3000
